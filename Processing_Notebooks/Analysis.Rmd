#Load packages
```{r}
library(httk)
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(purrr)
library(readr)
library(forcats)
library(viridis)
library(Rtsne)
library(tibble)
library(showtext)
library(extrafont)
library(pracma)
library(ggrepel)

windowsFonts(Arial = windowsFont("Arial"))
```

#Load 28d Feces
```{r}
#Imported in ng/g
feces_28  <- read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Input/Feces_28d.csv")

#remove number of pellets 0
  feces_28 <- feces_28[feces_28$Number.of.Fecal.Pellet.. != 0, ]


doses <- c("Naive", "Vehicle", " PFOA 1.5",  " PFOS 1.5")
print(colnames(feces_28))
pfas_cols <- c(
  "PFOA", "PFOS", "PFBA", "PFPeA", "PFHxA", "PFHpA", "PFNA", "PFDA", "PFUdA", "PFDoA", "PFTrDA", "PFTeDA", "HFPO.DA", "DONA","PFBS", "PFPeS", "PFHxS", "PFHpS", "PFNS", "PFDS",
  "X4_2.FTS", "X6_2_FTS", "X8_2.FTS")
mdls_naive_vehicle_166_05pfoa <- c(
  PFOA = 0.151, PFOS = 0.212, PFBA = 0.138, PFPeA = 0.105, PFHxA = 0.061,
  PFHpA = 0.090, PFNA = 0.112, PFDA = 0.087, PFUdA = 0.109, PFDoA = 0.077,
  PFTrDA = 0.127, PFTeDA = 0.062, HFPO.DA =0.154,DONA= 0.157,PFBS = 0.361, PFPeS = 0.214, PFHxS = 0.192, PFHpS = 0.124, PFNS = 0.225, PFDS = 0.140, `X4_2.FTS` = 0.057, `X6_2_FTS` = 0.098,
  `X8_2.FTS` = 0.093)

mdls_05pos_1pfoa_15pfoa <- c(
  PFOA = 1.44, PFOS = 3.79, PFBA = 0.866, PFPeA = 0.815, PFHxA = 0.770, PFHpA = 0.835, PFNA = 0.774, PFDA = 0.844, PFUdA = 0.633, PFDoA = 0.266, PFTrDA = 0.622, PFTeDA = 0.877, HFPO.DA =2.081,DONA= 0.725,PFBS = 0.602, PFPeS = 2.42, PFHxS = 1.72, PFHpS = 1.40, PFNS = 2.29, PFDS = 1.73, `X4_2.FTS` = 1.27, `X6_2_FTS` = 1.73,
  `X8_2.FTS` = 1.45)

mdls_1pfos <-  c(
  PFOA = 2.89, PFOS = 7.58, PFBA = 1.73, PFPeA = 1.63, PFHxA = 1.54, PFHpA = 1.67, PFNA = 1.55, PFDA = 1.69, PFUdA = 1.27, PFDoA = 0.53, PFTrDA = 1.24, PFTeDA = 1.75, HFPO.DA =4.16,DONA= 1.45,PFBS = 1.20, PFPeS = 4.84, PFHxS = 3.43, PFHpS = 2.79, PFNS = 4.59, PFDS = 3.46, `X4_2.FTS` = 2.54, `X6_2_FTS` = 3.47,
  `X8_2.FTS` = 7.24)

mdls_1.5pfos <-  c(
  PFOA = 7.22, PFOS = 18.95, PFBA = 4.33, PFPeA = 4.08, PFHxA = 3.85, PFHpA = 4.17, PFNA = 3.87, PFDA = 4.22, PFUdA = 3.16, PFDoA = 1.33, PFTrDA = 3.11, PFTeDA = 4.39, HFPO.DA =10.41,DONA= 3.63,PFBS = 3.01, PFPeS = 12.09, PFHxS = 8.58, PFHpS = 6.98, PFNS = 11.47, PFDS = 8.66, `X4_2.FTS` = 6.35, `X6_2_FTS` = 8.67,
  `X8_2.FTS` = 2.90)

mdls_df <- bind_rows(
  tibble(Group = "Naive", !!!mdls_naive_vehicle_166_05pfoa),
  tibble(Group = "Vehicle", !!!mdls_naive_vehicle_166_05pfoa),
  tibble(Group = "PFOA 1.5", !!!mdls_05pos_1pfoa_15pfoa),
  tibble(Group = "PFOS 1.5", !!!mdls_1.5pfos)
) %>%
  pivot_longer(
    -Group,
    names_to = "PFAS",
    values_to = "MDL"
  )

feces_long <- feces_28 %>%
  pivot_longer(
    cols = all_of(pfas_cols),
    names_to = "PFAS",
    values_to = "Value"
  )

feces_long <- feces_long %>%
  left_join(mdls_df, by = c("Group", "PFAS"))

feces_long <- feces_long %>%
  mutate(
    Value = ifelse(Value == "<MDL" & !is.na(MDL),
                   MDL / 2,
                   as.numeric(Value))
  )
feces_28_fixed <- feces_long %>%
  select(-MDL) %>%
  pivot_wider(
    names_from = PFAS,
    values_from = Value
  )


write.csv(feces_28_fixed, file = "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Output/Feces_PFAS_values_fixed_28d.csv", row.names = FALSE)

```

##Plotting 28d Feces Data
```{r}
feces_28 <- read.csv(file = "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Output/Feces_PFAS_values_fixed_28d.csv")

other_pfas <- setdiff(pfas_cols, c("PFOS", "PFOA"))
plasma_colors <- viridis(length(other_pfas), option = "plasma")
names(plasma_colors) <- other_pfas

custom_colors <- c(
  "PFOS" = "red",   
  "PFOA" = "blue",    
  plasma_colors          
)

group_levels <- c(
  "Naive", "Vehicle",
  paste("PFOS", c("1.5")),
  paste("PFOA", c("1.5"))
)

data_combined_long <- feces_28 %>%
  pivot_longer(
    cols = all_of(pfas_cols),
    names_to = "PFAS_name",
    values_to = "PFAS_conc"
  ) %>%
  filter(!is.na(PFAS_conc)) %>%
  mutate(
    PFAS_conc = as.numeric(PFAS_conc),
    group = factor(Group, levels = group_levels),
    PFAS_name = factor(PFAS_name, levels = names(custom_colors)) 
  )
average_pfas <- feces_28 %>%
  group_by(Group) %>%
  summarise(
    Mean_PFOS = format(mean(PFOS, na.rm = TRUE), scientific = FALSE),
    Mean_PFOA = format(mean(PFOA, na.rm = TRUE), scientific = FALSE),
    .groups = "drop"
  )

print(average_pfas)
shape_map <- c(`Male` = 24, `Female` = 21)


data_combined_long <- subset(data_combined_long, !(Group %in% "Naive"))
# Plot
p <- ggplot(data_combined_long, aes(x = group, y = PFAS_conc)) +
  geom_jitter(aes(color = factor(PFAS_name),
                  fill = factor(PFAS_name),
                  shape = Sex),
              size = 2, alpha = 0.5, stroke = 1) +
  scale_color_manual(values = custom_colors, name = "PFAS_name") +
  scale_fill_manual(values = custom_colors, name = "PFAS_name") +
  scale_shape_manual(values = shape_map, name = "Sex") +
 coord_cartesian(ylim = c(0, 15000)) +  
  theme_minimal() +
  theme(
        text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "none",
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank()
  )
print(p)
ggsave(filename = "../plots/Feces_conc_28d.png", plot = p, width = 5, height = 5, dpi = 300,bg = "white")

replicate_summary <- feces_28 %>%
  group_by(Group) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))

```

#Load 56d Feces
```{r}
#IMPORTED ng/g
feces_56  <- read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Input/Feces_56d.csv")
#remove number of pellets 0
  feces_56 <- feces_56[feces_56$Number.of.Fecal.Pellet.. != 0, ]

mdls_df <- bind_rows(
  tibble(Group = "Naive", !!!mdls_naive_vehicle_166_05pfoa),
  tibble(Group = "Vehicle", !!!mdls_naive_vehicle_166_05pfoa),
  tibble(Group = "PFOS 0.166", !!!mdls_naive_vehicle_166_05pfoa),
  tibble(Group = "PFOA 0.166", !!!mdls_naive_vehicle_166_05pfoa),
  tibble(Group = "PFOA 0.5", !!!mdls_naive_vehicle_166_05pfoa),
  tibble(Group = "PFOS 0.5", !!!mdls_05pos_1pfoa_15pfoa),
  tibble(Group = "PFOA 1", !!!mdls_05pos_1pfoa_15pfoa),
  tibble(Group = "PFOA 1.5", !!!mdls_05pos_1pfoa_15pfoa),
  tibble(Group = "PFOS 1", !!!mdls_1pfos),
  tibble(Group = "PFOS 1.5", !!!mdls_1.5pfos)
) %>%
  pivot_longer(
    -Group,
    names_to = "PFAS",
    values_to = "MDL"
  )

feces_long <- feces_56 %>%
  pivot_longer(
    cols = all_of(pfas_cols),
    names_to = "PFAS",
    values_to = "Value"
  )

feces_long <- feces_long %>%
  left_join(mdls_df, by = c("Group", "PFAS"))

feces_long <- feces_long %>%
  mutate(
    Value = ifelse(Value == "<MDL" & !is.na(MDL),
                   MDL / 2,
                   as.numeric(Value))
  )
feces_56_fixed <- feces_long %>%
  select(-MDL) %>%
  pivot_wider(
    names_from = PFAS,
    values_from = Value
  )

write.csv(feces_56_fixed, file = "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Output/Feces_PFAS_values_fixed_56d.csv", row.names = FALSE)
```

##Plotting 56d Feces Data
```{r}
feces_56 <- read.csv(file = "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Output/Feces_PFAS_values_fixed_56d.csv" )
pfas_cols <- c(
  "PFOA", "PFOS", "PFBA", "PFPeA", "PFHxA", "PFHpA", "PFNA", "PFDA", "PFUdA", "PFDoA", "PFTrDA", "PFTeDA", "HFPO.DA", "DONA","PFBS", "PFPeS", "PFHxS", "PFHpS", "PFNS", "PFDS",
  "X4_2.FTS", "X6_2_FTS", "X8_2.FTS")
other_pfas <- setdiff(pfas_cols, c("PFOS", "PFOA"))
plasma_colors <- viridis(length(other_pfas), option = "plasma")
names(plasma_colors) <- other_pfas

custom_colors <- c(
  "PFOS" = "red",   
  "PFOA" = "blue",   
  plasma_colors          
)

group_levels <- c("Naive", "Vehicle", "PFOS 0.166", "PFOS 0.5", "PFOS 1", "PFOS 1.5", "PFOA 0.166", "PFOA 0.5", "PFOA 1", "PFOA 1.5")


data_combined_long <- feces_56 %>%
  pivot_longer(
    cols = all_of(pfas_cols),
    names_to = "PFAS_name",
    values_to = "PFAS_conc"
  ) %>%
  filter(!is.na(PFAS_conc)) %>%
  mutate(
    PFAS_conc = as.numeric(PFAS_conc),
    group = factor(Group, levels = group_levels),
    PFAS_name = factor(PFAS_name, levels = names(custom_colors)) 
  )

average_pfas <- feces_56 %>%
  group_by(Group) %>%
  summarise(
    Mean_PFOS = format(mean(PFOS, na.rm = TRUE), scientific = FALSE),
    Mean_PFOA = format(mean(PFOA, na.rm = TRUE), scientific = FALSE),
    .groups = "drop"
  )

print(average_pfas)

shape_map <- c(`Male` = 24, `Female` = 21)
data_combined_long <- subset(data_combined_long, !(Group %in% "Naive"))
# Plot
p <- ggplot(data_combined_long, aes(x = group, y = PFAS_conc)) +
  geom_jitter(aes(color = factor(PFAS_name),
                  fill = factor(PFAS_name),
                  shape = Sex),
              size = 2, alpha = 0.5, stroke = 1) +
  scale_color_manual(values = custom_colors, name = "PFAS_name") +
  scale_fill_manual(values = custom_colors, name = "PFAS_name") +
  scale_shape_manual(values = shape_map, name = "Sex") +
 coord_cartesian(ylim = c(0, 15000)) +  
  theme_minimal() +
  theme(
        text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "none",
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank()
  )
print(p)
ggsave(filename = "../plots/feces_56_conc.png", plot = p, width = 12.5, height = 5, dpi = 300,bg = "white")

replicate_summary <- feces_56%>%
  group_by(Group) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```


#Correlation between liver and feces
```{r}
custom_colors_named <- c(
  "Vehicle" = "#330597",
  "PFOS 0.166"   = "#b12a90",
  "PFOS 0.5"     = "#d35171",
  "PFOS 1"       = "#f68f44",
  "PFOS 1.5"     = "#fec029",
    "PFOA 0.166"   = "#b12a90",
  "PFOA 0.5"     = "#d35171",
  "PFOA 1"       = "#f68f44",
  "PFOA 1.5"     = "#fec029"
)
shape_map <- c(`28` = 24, `56` = 21)
#########56 day
#Imported in mg/kg
liver_56  <- read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Input/Liver_PFAS_values_fixed_56d.csv")
liver_28  <- read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Input/Liver_PFAS_values_fixed_28d.csv")

liver_28 <- liver_28 %>% mutate(Time = 28)
liver_56 <- liver_56 %>% mutate(Time = 56)
liver <- rbind(liver_28, liver_56)


liver <- liver %>%
  mutate(Group2 = if_else(Group %in% c("Naive", "Vehicle"),
                         paste("control", Group),
                         Group))
liver <- liver %>%
  separate(Group2, into = c("PFAS", "Dose"), sep = " ", remove = T)

controls <- liver %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

liver <- liver %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

liver_pfos <- subset(liver) %>%
  select("Mouse.ID", "PFOS", "Group", "Sex", "PFAS", "Time")
liver_pfoa <- subset(liver) %>%
  select("Mouse.ID", "PFOA", "Group", "Sex", "PFAS", "Time")

#imported ng/g
feces_56 <- read.csv(file = "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Input/Feces_PFAS_values_fixed_56d.csv" )
feces_28 <- read.csv(file = "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Input/Feces_PFAS_values_fixed_28d.csv" )

feces_28 <- feces_28 %>% mutate(Time = 28)
feces_56 <- feces_56 %>% mutate(Time = 56)
feces <- rbind(feces_28, feces_56)

feces <- feces %>% 
  mutate(across(PFOA:X8_2.FTS, ~ .x * 1e-6))  #NG/G TO MG/KG

feces <- feces %>%
  mutate(Group2 = if_else(Group %in% c("Naive", "Vehicle"),
                         paste("control", Group),
                         Group))
feces <- feces %>%
  separate(Group2, into = c("PFAS", "Dose"), sep = " ", remove = T)

controls <- feces %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

feces <- feces %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

feces_pfos <- subset(feces) %>%
  select("Mouse.ID", "PFOS", "Group", "Sex", "PFAS", "Time")
feces_pfoa <- subset(feces) %>%
  select("Mouse.ID", "PFOA", "Group", "Sex", "PFAS", "Time")

pfos<- inner_join(
  feces_pfos,
  liver_pfos,
  by = c("Mouse.ID","Group", "Sex", "PFAS", "Time"),
  suffix = c("_feces","_liver")
) 
pfos <- subset(pfos, PFAS == "PFOS")

pfoa<- inner_join(
  feces_pfoa,
  liver_pfoa,
  by = c("Mouse.ID","Group", "Sex", "PFAS", "Time"),
  suffix = c( "_feces","_liver")
) 
pfoa <- subset(pfoa, PFAS == "PFOA")

pfos <- subset(pfos, !(Group %in% "Naive"))
pfoa <- subset(pfoa, !(Group %in% "Naive"))
p <- ggplot(pfos, aes(x = PFOS_liver, y = PFOS_feces)) +
  # Single lm line
  geom_smooth(method = "lm", linetype = "dashed", color = "red", inherit.aes = FALSE,
              aes(x = PFOS_liver, y = PFOS_feces)) +
    # Jittered points
  geom_jitter(aes(shape = factor(Time), color = factor(Group), fill = factor(Group)),
              size = 3, alpha = 0.5, stroke = 1) +
  # Labels
  labs(title = "Correlation between Liver and Feces",
       x = "Liver (mg/kg)",
       y = "Feces (mg/kg)") +
  
  # Manual scales
  scale_color_manual(name = "Group", values = custom_colors_named) +
  scale_fill_manual(name = "Group", values = custom_colors_named) +
  scale_shape_manual(name = "Time (days)", values = shape_map) +
  
  # Theme
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  )

print(p)
ggsave(filename = "../plots/fecesxliver_pfos.png", plot = p, width = 7, height = 6, dpi = 300,bg = "white")

p <- ggplot(pfoa, aes(x = PFOA_liver, y = PFOA_feces)) +
  # Single lm line
  geom_smooth(method = "lm", linetype = "dashed", color = "red", inherit.aes = FALSE,
              aes(x = PFOA_liver, y = PFOA_feces)) +
    # Jittered points
  geom_jitter(aes(shape = factor(Time), color = factor(Group), fill = factor(Group)),
              size = 3, alpha = 0.5, stroke = 1) +
  # Labels
  labs(title = "Correlation between Liver and Feces",
       x = "Liver (mg/kg)",
       y = "Feces (mg/kg)") +
  
  # Manual scales
  scale_color_manual(name = "Group", values = custom_colors_named) +
  scale_fill_manual(name = "Group", values = custom_colors_named) +
  scale_shape_manual(name = "Time (days)", values = shape_map) +
  
  # Theme
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  )
print(p)
ggsave(filename = "../plots/fecesxliver_pfoa.png", plot = p, width = 7, height = 6, dpi = 300,bg = "white")
replicate_summary <- pfoa%>%
  group_by(Group, Time) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))


replicate_summary <- pfos%>%
  group_by(Group, Time) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```

#Correlation between plasma and feces
```{r}
#########56 day
#Imported in mg/kg
plasma_56 <- read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Input/Plasma_PFAS_values_fixed_56d.csv")
plasma_28 <- read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Input/plasma_PFAS_values_fixed_28d.csv")
plasma_28 <- plasma_28 %>% mutate(Time = 28)
plasma_56 <- plasma_56 %>% mutate(Time = 56)
plasma <- rbind(plasma_28, plasma_56)


plasma <- plasma %>%
  mutate(Group2 = if_else(Group %in% c("Naive", "Vehicle"),
                         paste("control", Group),
                         Group))
plasma <- plasma %>%
  separate(Group2, into = c("PFAS", "Dose"), sep = " ", remove = T)

controls <- plasma %>%
  filter(Dose %in% c("Naive", "Vehicle")) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(PFAS = rep(c("PFOS", "PFOA"), times = n() / 2))

plasma <- plasma %>%
  filter(!(Dose %in% c("Naive", "Vehicle"))) %>%
  bind_rows(controls)

plasma_pfos <- subset(plasma) %>%
  select("Mouse.ID", "PFOS", "Group", "Sex", "PFAS", "Time")
plasma_pfoa <- subset(plasma) %>%
  select("Mouse.ID", "PFOA", "Group", "Sex", "PFAS", "Time")

pfos<- inner_join(
  feces_pfos,
  plasma_pfos,
  by = c("Mouse.ID","Group", "Sex", "PFAS", "Time"),
  suffix = c("_feces","_plasma")
) 
pfos <- subset(pfos, PFAS == "PFOS")

pfoa<- inner_join(
  feces_pfoa,
  plasma_pfoa,
  by = c("Mouse.ID","Group", "Sex", "PFAS", "Time"),
  suffix = c( "_feces","_plasma")
) 
pfoa <- subset(pfoa, PFAS == "PFOA")

pfos <- subset(pfos, !(Group %in% "Naive"))
pfoa <- subset(pfoa, !(Group %in% "Naive"))

p <- ggplot(pfos, aes(x = PFOS_plasma, y = PFOS_feces)) +
  # Single lm line
  geom_smooth(method = "lm", linetype = "dashed", color = "red", inherit.aes = FALSE,
              aes(x = PFOS_plasma, y = PFOS_feces)) +
    # Jittered points
  geom_jitter(aes(shape = factor(Time), color = factor(Group), fill = factor(Group)),
              size = 3, alpha = 0.5, stroke = 1) +
  # Labels
  labs(title = "Correlation between plasma and Feces",
       x = "plasma (mg/L)",
       y = "Feces (mg/kg)") +
  
  # Manual scales
  scale_color_manual(name = "Group", values = custom_colors_named) +
  scale_fill_manual(name = "Group", values = custom_colors_named) +
  scale_shape_manual(name = "Time (days)", values = shape_map) +
  
  # Theme
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  )

print(p)
ggsave(filename = "../plots/fecesxplasma_pfos.png", plot = p, width = 7, height = 6, dpi = 300,bg = "white")

p <- ggplot(pfoa, aes(x = PFOA_plasma, y = PFOA_feces)) +
  # Single lm line
  geom_smooth(method = "lm", linetype = "dashed", color = "red", inherit.aes = FALSE,
              aes(x = PFOA_plasma, y = PFOA_feces)) +
    # Jittered points
  geom_jitter(aes(shape = factor(Time), color = factor(Group), fill = factor(Group)),
              size = 3, alpha = 0.5, stroke = 1) +
  # Labels
  labs(title = "Correlation between plasma and Feces",
       x = "plasma (mg/L)",
       y = "Feces (mg/kg)") +
  
  # Manual scales
  scale_color_manual(name = "Group", values = custom_colors_named) +
  scale_fill_manual(name = "Group", values = custom_colors_named) +
  scale_shape_manual(name = "Time (days)", values = shape_map) +
  
  # Theme
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  )
print(p)
ggsave(filename = "../plots/fecesxplasma_pfoa.png", plot = p, width = 7, height = 6, dpi = 300,bg = "white")

replicate_summary <- pfoa%>%
  group_by(Group, Time) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))


replicate_summary <- pfos%>%
  group_by(Group, Time) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```


#Load Everything togther
```{r}
mw_pfos <- 538.12  # g/mol for PFOS
mw_pfoa <- 414.07  # g/mol for PFOA

#Imported in mg/L
plasma_28 <- read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Input/plasma_PFAS_values_fixed_28d.csv")
plasma_56 <- read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Input/Plasma_PFAS_values_fixed_56d.csv")

#Imported in mg/kg
liver_28  <- read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Input/Liver_PFAS_values_fixed_28d.csv")
liver_56  <- read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Input/Liver_PFAS_values_fixed_56d.csv")

#Imported ng/g
feces_56 <- read.csv(file = "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Output/Feces_PFAS_values_fixed_56d.csv" )
feces_28 <- read.csv(file = "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Output/Feces_PFAS_values_fixed_28d.csv" )

process_pfas_file <- function(df, tissue, timepoint) {
  df <- df %>% filter(Group != "Naive")
  df_vehicle <- df %>%
    filter(Group == "Vehicle") %>%
    mutate(
      PFAS_type = "PFOA",
      PFAS_conc = PFOA,
      Tissue = tissue,
      Time = timepoint
    )
  df_vehicle_dup <- df_vehicle %>%
    mutate(
      PFAS_type = "PFOS",
      PFAS_conc = PFOS
    )
  df_vehicles_all <- bind_rows(df_vehicle, df_vehicle_dup)
  df_exposed <- df %>%
    filter(Group != "Vehicle") %>%
    mutate(
      PFAS_type = case_when(
        str_starts(Group, "PFOS") ~ "PFOS",
        str_starts(Group, "PFOA") ~ "PFOA",
        TRUE ~ NA_character_
      ),
      PFAS_conc = case_when(
        PFAS_type == "PFOS" ~ PFOS,
        PFAS_type == "PFOA" ~ PFOA,
        TRUE ~ NA_real_
      ),
      Tissue = tissue,
      Time = timepoint
    )
  df_final <- bind_rows(df_vehicles_all, df_exposed) %>%
    dplyr::select(Mouse.ID, Group, PFAS_type, PFAS_conc, Tissue, Time, Sex)
  return(df_final)
}

plasma_28_clean <- process_pfas_file(plasma_28, tissue = "Plasma", timepoint = 28)
plasma_56_clean <- process_pfas_file(plasma_56, tissue = "Plasma", timepoint = 56)
liver_28_clean  <- process_pfas_file(liver_28,  tissue = "Liver",  timepoint = 28)
liver_56_clean  <- process_pfas_file(liver_56,  tissue = "Liver",  timepoint = 56)
feces_28_clean  <- process_pfas_file(feces_28,  tissue = "Feces",  timepoint = 28)
feces_56_clean  <- process_pfas_file(feces_56,  tissue = "Feces",  timepoint = 56)


pfas_obs_all <- bind_rows(plasma_28_clean, plasma_56_clean, liver_28_clean, liver_56_clean,feces_28_clean,feces_56_clean)


pfas_obs_all <- pfas_obs_all %>%
  mutate(
    Dose = case_when(
      Group == "Vehicle" ~ 0,
      TRUE ~ as.numeric(str_extract(Group, "\\d+\\.?\\d*"))
    ),
    mw = case_when(
      PFAS_type == "PFOA" ~ mw_pfoa,
      PFAS_type == "PFOS" ~ mw_pfos,
      TRUE ~ NA_real_
    ),
    PFAS_mg_L_eq = case_when(
      Tissue == "Plasma" ~ PFAS_conc,                 # already mg/L
      Tissue %in% c("Liver") ~ PFAS_conc,              # mg/kg ≈ mg/L
      Tissue == "Feces" ~ PFAS_conc * 1e-6,            # ng/g → mg/kg and same # mg/kg ≈ mg/L
      TRUE ~ NA_real_
    ),

    # ---- CONVERT TO µM ----
    uM = PFAS_mg_L_eq / mw * 1000,

    # Optional reporting columns
    mg_L = ifelse(Tissue == "Plasma", PFAS_conc, NA_real_),
    ng_L = ifelse(Tissue == "Plasma", PFAS_conc * 1e6, NA_real_),
    mg_kg = ifelse(Tissue != "Plasma", PFAS_conc, NA_real_)
  ) %>%
  select(-mw)

```


#Validate httk
##Load PFAS information
```{r}
available_rblood2plasma(
  chem.cas = "1763-23-1",
    species = "Mouse",
    suppress.messages = TRUE,
  class.exclude = TRUE,
) 
available_rblood2plasma(
  chem.cas = "1763-23-1",
    species = "Human",
    suppress.messages = TRUE,
  class.exclude = TRUE,
)

get_caco2(
  chem.cas = "1763-23-1",
  suppress.messages = FALSE
)
available_rblood2plasma(
  chem.cas = "335-67-1",
    species = "Human",
    suppress.messages = TRUE,
  class.exclude = TRUE,
)
available_rblood2plasma(
  chem.cas = "335-67-1",
    species = "Mouse",
    suppress.messages = TRUE,
  class.exclude = TRUE,
)

get_caco2(
  chem.cas = "335-67-1",
  suppress.messages = FALSE
)
info_pfos_human <- subset(
  pfas.clearance,
  DTXSID == "DTXSID3031864" & Species == "Human"
)
info_pfos_human_avg <- info_pfos_human %>%
  dplyr::summarise(
    dplyr::across(where(is.numeric), ~ mean(.x, na.rm = TRUE))
  )
info_pfos_human_avg

info_pfoa_human <- subset(
  pfas.clearance,
  DTXSID == "DTXSID8031865" & Species == "Human"
)
info_pfoa_human_avg <- info_pfoa_human %>%
  dplyr::summarise(
    dplyr::across(where(is.numeric), ~ mean(.x, na.rm = TRUE))
  )
info_pfoa_human_avg


info_pfos_mouse <- subset(
  pfas.clearance,
  DTXSID == "DTXSID3031864" & Species == "Mouse"
)
info_pfos_mouse

info_pfoa_mouse <- subset(
  pfas.clearance,
  DTXSID == "DTXSID8031865" & Species == "Mouse"
)
info_pfoa_mouse

#account for cd1 to c57 conversion
pfoa_clearance_m <- 0.001331 *1.5 * 0.1805
pfoa_clearance_f <- 0.001851 *1.5 * 0.1805
```
##PFOS Plasma pfas1comp httk 2.7.2.
```{r}
# ---- Setup ----
shape_map <- c(`Male` = 24, `Female` = 21)
custom_colors_named <- c(
  "0"     = "#330597",
  "0.166" = "#b12a90",
  "0.5"   = "#d35171",
  "1"     = "#f68f44",
  "1.5"   = "#fec029"
)

# ---- Data Prep ----
pfos_obs <- pfas_obs_all %>%
  filter(PFAS_type == "PFOS") %>%
  mutate(uM = as.numeric(trimws(uM)))

plasma_obs <- pfos_obs %>%
  filter(Tissue == "Plasma") %>%
  select(Dose, Time, uM, Mouse.ID, Sex)

dose_vec <- unique(pfos_obs$Dose)
time_vec <- unique(pfos_obs$Time)
sim_days <- max(time_vec)

# ---- Run PFAS model for both sexes ----
pred_1comp_all <- map_df(dose_vec, function(dose) {

  # ---- Female model ----
  pars_f <- parameterize_pfas1comp(
    chem.cas = "1763-23-1",
    species = "Mouse",
    dosingadj = "Oral",
    suppress.messages = TRUE
  )
  pars_f$Funbound.plasma <- 0.00256
  pars_f$Vdist <- 0.261
  pars_f$kelim <- 0.0008463
  pars_f$Rblood2plasma <- 0.588
  pars_f$Caco2.Pab <- 1.6

  sim_f <- solve_1comp(
    parameters    = pars_f,
    daily.dose    = dose,
    doses.per.day = 1,
    days          = sim_days,
    output.units  = "uM"
  )

  c_f <- if ("Cplasma" %in% colnames(sim_f)) sim_f[, "Cplasma"] else sim_f[, "Ccompartment"] / pars_f$Rblood2plasma
  pred_f <- approx(x = sim_f[, "time"], y = c_f, xout = time_vec, rule = 2)

  df_f <- tibble(
    Dose = dose,
    Time = pred_f$x,
    Predicted_Conc_uM = pred_f$y,
    Model = "PFAS-1comp Female"
  )

  # ---- Male model ----
  pars_m <- parameterize_pfas1comp(
    chem.cas = "1763-23-1",
    species = "Mouse",
    dosingadj = "Oral",
    suppress.messages = TRUE
  )
  pars_m$Funbound.plasma <-0.00256 #mouse c57 file:///C:/Users/aloan/Downloads/toxics-12-00253.pdf
  pars_m$Vdist <- 0.263
  pars_m$kelim <- 0.0007290 
  pars_m$Rblood2plasma <- 0.588
  pars_m$Caco2.Pab <- 1.6
  
  pars <- rbind(pars_f, pars_m)
write.csv(pars, "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Output/pars_pfos_1comp.csv")
  sim_m <- solve_1comp(
    parameters    = pars_m,
    daily.dose    = dose,
    doses.per.day = 1,
    days          = sim_days,
    output.units  = "uM"
  )

  c_m <- if ("Cplasma" %in% colnames(sim_m)) sim_m[, "Cplasma"] else sim_m[, "Ccompartment"] / pars_m$Rblood2plasma
  pred_m <- approx(x = sim_m[, "time"], y = c_m, xout = time_vec, rule = 2)

  df_m <- tibble(
    Dose = dose,
    Time = pred_m$x,
    Predicted_Conc_uM = pred_m$y,
    Model = "PFAS-1comp Male"
  )

  bind_rows(df_f, df_m)
})

# ---- Combine Dose-Time ----
plasma_obs$Dose_Time <- paste0(plasma_obs$Dose, " (", plasma_obs$Time, ")")
pred_1comp_all$Dose_Time <- paste0(pred_1comp_all$Dose, " (", pred_1comp_all$Time, ")")
pred_1comp_all <- subset(pred_1comp_all, !(Dose_Time %in% c("0.166 (28)", "0.5 (28)", "1 (28)")))
# ---- Plot ----
p <- ggplot() +
  geom_jitter(
    data = plasma_obs,
    aes(x = factor(Dose_Time), y = uM, color = factor(Dose), fill = factor(Dose), shape = Sex),
    size = 2, alpha = 0.5, width = 0.1, stroke = 1
  ) +
  geom_point(
    data = pred_1comp_all,
    aes(x = factor(Dose_Time), y = Predicted_Conc_uM, color = Model, shape = Model),
    size = 2
  ) +
  labs(
    title = "PFOS — Plasma: PFAS 1-comp vs Observed",
    x = "Dose (mg/kg/day)",
    y = "Plasma (µM)",
    color = "Dose / Model"
  ) +
  scale_color_manual(
    values = c(custom_colors_named, "PFAS-1comp Female" = "red", "PFAS-1comp Male" = "red")
  ) +
  scale_fill_manual(values = custom_colors_named) +
  scale_shape_manual(
    values = c(shape_map, "PFAS-1comp Female" = 16, "PFAS-1comp Male" = 17)
  ) +
  theme_minimal() +
  coord_cartesian(ylim = c(-10, 800)) +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "b",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  )

print(p)
ggsave(filename = "../plots/pfos_1comp.png", plot = p, width = 6, height = 3, dpi = 300,bg = "white")


obs_vs_pred_table <- plasma_obs %>%
  inner_join(pred_1comp_all, by = "Dose_Time", "Sex") %>%
  mutate(
    diff_uM   = Predicted_Conc_uM - uM,        # absolute difference
    fold_diff = Predicted_Conc_uM / uM,        # fold-change
    percent_diff = 100 * diff_uM / uM          # % difference
  ) %>%
  select(
    Dose_Time,
    Sex,
    Observed_uM  = uM,
    Predicted_uM = Predicted_Conc_uM,
    diff_uM,
    fold_diff,
    percent_diff
  ) %>%
  arrange(desc(fold_diff))


obs_vs_pred_table %>%
summarise(
    n = n(),
    mean_diff_uM = mean(diff_uM, na.rm = TRUE),
    mean_diff_uM = mean(diff_uM, na.rm = TRUE),
    mean_fold  = mean(fold_diff, na.rm = TRUE),
    times_lower = ifelse(mean_fold < 1, 1 / mean_fold, NA_real_),
    times_higher = ifelse(mean_fold > 1, mean_fold, NA_real_),
    .groups = "drop"
  )
pred_1comp_avg <- pred_1comp_all %>%
  group_by(Dose, Time) %>%
  summarise(
    Predicted_Conc_uM = mean(Predicted_Conc_uM, na.rm = TRUE),
    .groups = "drop"
  )
replicate_summary <- plasma_obs%>%
  group_by(Dose, Time) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```

##PFOA Plasma pfas1comp httk 2.7.2.
```{r}

available_rblood2plasma(
  chem.cas = "335-67-1",
    species = "Mouse",
    suppress.messages = TRUE,
  class.exclude = TRUE,
)

# ---- Data Prep ----
pfoa_obs <- pfas_obs_all %>%
  filter(PFAS_type == "PFOA") %>%
  mutate(uM = as.numeric(trimws(uM)))

plasma_obs <- pfoa_obs %>%
  filter(Tissue == "Plasma") %>%
  select(Dose, Time, uM, Mouse.ID, Sex)

dose_vec <- unique(pfoa_obs$Dose)
time_vec <- unique(pfoa_obs$Time)
sim_days <- max(time_vec)

# ---- Run PFAS model for both sexes ----
pred_1comp_all <- map_df(dose_vec, function(dose) {

  # ---- Female model ----
  pars_f <- parameterize_pfas1comp(
    chem.cas = "335-67-1",
    species = "Mouse",
    dosingadj = "Oral",
    suppress.messages = TRUE
  )
  pars_f$Funbound.plasma <-  0.0142 #mouse c57 file:///C:/Users/aloan/Downloads/toxics-12-00253.pdf
  pars_f$Vdist <- 0.1805
  pars_f$kelim <- 0.001851 * 1.5 #https://pmc.ncbi.nlm.nih.gov/articles/PMC4464984/
  pars_f$Rblood2plasma <- 0.9047 # from r2bp function
  pars_f$Caco2.Pab <- 1.6

  sim_f <- solve_1comp(
    parameters    = pars_f,
    daily.dose    = dose,
    doses.per.day = 1,
    days          = sim_days,
    output.units  = "uM"
  )

  c_f <- if ("Cplasma" %in% colnames(sim_f)) sim_f[, "Cplasma"] else sim_f[, "Ccompartment"] / pars_f$Rblood2plasma
  pred_f <- approx(x = sim_f[, "time"], y = c_f, xout = time_vec, rule = 2)

  df_f <- tibble(
    Dose = dose,
    Time = pred_f$x,
    Predicted_Conc_uM = pred_f$y,
    Model = "PFAS-1comp Female"
  )

  # ---- Male model ----
  pars_m <- parameterize_pfas1comp(
    chem.cas = "335-67-1",
    species = "Mouse",
    dosingadj = "Oral",
    suppress.messages = TRUE
  )
  pars_m$Funbound.plasma <- 0.0142 #mouse c57 file:///C:/Users/aloan/Downloads/toxics-12-00253.pdf
  pars_m$Vdist <- 0.1805
  pars_m$kelim <- 0.001331* 1.5 #https://pmc.ncbi.nlm.nih.gov/articles/PMC4464984/
  pars_m$Rblood2plasma <- 0.9047 # from r2bp function
  pars_m$Caco2.Pab <- 1.6
  pars <- rbind(pars_f, pars_m)
write.csv(pars, "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Output/pars_pfoa_1comp.csv")
  sim_m <- solve_1comp(
    parameters    = pars_m,
    daily.dose    = dose,
    doses.per.day = 1,
    days          = sim_days,
    output.units  = "uM"
  )

  c_m <- if ("Cplasma" %in% colnames(sim_m)) sim_m[, "Cplasma"] else sim_m[, "Ccompartment"] / pars_m$Rblood2plasma
  pred_m <- approx(x = sim_m[, "time"], y = c_m, xout = time_vec, rule = 2)

  df_m <- tibble(
    Dose = dose,
    Time = pred_m$x,
    Predicted_Conc_uM = pred_m$y,
    Model = "PFAS-1comp Male"
  )

  bind_rows(df_f, df_m)
})

# ---- Combine Dose-Time ----
plasma_obs$Dose_Time <- paste0(plasma_obs$Dose, " (", plasma_obs$Time, ")")
pred_1comp_all$Dose_Time <- paste0(pred_1comp_all$Dose, " (", pred_1comp_all$Time, ")")
pred_1comp_all <- subset(pred_1comp_all, !(Dose_Time %in% c("0.166 (28)", "0.5 (28)", "1 (28)")))
# ---- Plot ----
p <- ggplot() +
  geom_jitter(
    data = plasma_obs,
    aes(x = factor(Dose_Time), y = uM, color = factor(Dose), fill = factor(Dose), shape = Sex),
    size = 2, alpha = 0.5, width = 0.1, stroke = 1
  ) +
  geom_point(
    data = pred_1comp_all,
    aes(x = factor(Dose_Time), y = Predicted_Conc_uM, color = Model, shape = Model),
    size = 2
  ) +
  labs(
    title = "PFOA — Plasma: PFAS 1-comp vs Observed",
    x = "Dose (mg/kg/day)",
    y = "Plasma (µM)",
    color = "Dose / Model"
  ) +
  scale_color_manual(
    values = c(custom_colors_named, "PFAS-1comp Female" = "red", "PFAS-1comp Male" = "red")
  ) +
  scale_fill_manual(values = custom_colors_named) +
  scale_shape_manual(
    values = c(shape_map, "PFAS-1comp Female" = 16, "PFAS-1comp Male" = 17)
  ) +
  theme_minimal() +
  coord_cartesian(ylim = c(-10, 800)) +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "b",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  )


print(p)
ggsave(filename = "../plots/pfoa_1comp.png", plot = p, width = 6, height = 3, dpi = 300,bg = "white")


obs_vs_pred_table <- plasma_obs %>%
  inner_join(pred_1comp_all, by = "Dose_Time") %>%
  mutate(
    diff_uM   = Predicted_Conc_uM - uM,        # absolute difference
    fold_diff = Predicted_Conc_uM / uM,        # fold-change
    percent_diff = 100 * diff_uM / uM          # % difference
  ) %>%
  select(
    Dose_Time,
    Sex,
    Observed_uM  = uM,
    Predicted_uM = Predicted_Conc_uM,
    diff_uM,
    fold_diff,
    percent_diff
  ) %>%
  arrange(desc(fold_diff))


obs_vs_pred_table %>%
summarise(
    n = n(),
    mean_diff_uM = mean(diff_uM, na.rm = TRUE),
    mean_diff_uM = mean(diff_uM, na.rm = TRUE),
    mean_fold  = mean(fold_diff, na.rm = TRUE),
    times_lower = ifelse(mean_fold < 1, 1 / mean_fold, NA_real_),
    times_higher = ifelse(mean_fold > 1, mean_fold, NA_real_),
    .groups = "drop"
  )
pred_1comp_avg <- pred_1comp_all %>%
  group_by(Dose, Time) %>%
  summarise(
    Predicted_Conc_uM = mean(Predicted_Conc_uM, na.rm = TRUE),
    .groups = "drop"
  )
replicate_summary <- plasma_obs%>%
  group_by(Dose, Time) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```
###PFOS Plasma PBTK solve_pbtk (class.exclude =F)
```{r}
shape_map <- c(`Male` = 24, `Female` = 21)
pfos_obs <- pfas_obs_all %>%
  filter(
    PFAS_type == "PFOS",
    Tissue != "Feces"
  )

dose_vec <- unique(pfos_obs$Dose)
time_vec <- unique(pfos_obs$Time)
sim_days <- max(time_vec)
tissues_all <- c("Plasma", "Liver", "Kidney", "Lung", "Gut", "Rest")

# Function to map tissue names to PBTK model column names
tissue_to_col <- function(tissue) {
  switch(tissue,
         Plasma = "Cplasma",
         Liver = "Cliver",
         Kidney = "Ckidney",
         Lung = "Clung",
         Gut = "Cgut",
         Rest = "Crest")
}

# Base parameterization (run once)
pars_base <- parameterize_pbtk(
  chem.cas = "1763-23-1",
  species = "Mouse",
  dosingadj = "Oral",
  class.exclude = FALSE,
  suppress.messages = TRUE,
  default.to.human = TRUE
)

# ---- Male parameters ----
pars_m <- pars_base
pars_m$Vdist <- 0.263
pars_m$kelim <- 0.0007290
pars_m$Funbound.plasma <- 0.00256
pars_m$Rblood2plasma <- 0.588
pars_m$Caco2.Pab <- 1.6
pars_m$Clmetabolismc <- 0.0001917
pars_m$Fabsgut <- 0.9798 #https://www.ncbi.nlm.nih.gov/books/NBK614278/
pars_m$kgutabs <- 1.572


# ---- Female parameters ----
pars_f <- pars_base
pars_f$Vdist <- 0.261
pars_f$kelim <- 0.0008463
pars_f$Funbound.plasma <- 0.00256
pars_f$Rblood2plasma <- 0.588
pars_f$Caco2.Pab <- 1.6
pars_f$Clmetabolismc <- 0.0002209
pars_f$Fabsgut <- 0.9798 #https://www.ncbi.nlm.nih.gov/books/NBK614278/
pars_f$kgutabs <- 1.572


pars_f_df <- data.frame(
  Parameter = names(pars_f),
  Female = unlist(pars_f)
)

pars_m_df <- data.frame(
  Parameter = names(pars_m),
  Male = unlist(pars_m)
)

pars <- full_join(pars_f_df, pars_m_df, by = "Parameter")

# Write both parameter sets
write.csv(pars, "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Output/pars_pfos_pbtk.csv")


# Run model and get predictions
predictions <- map_df(dose_vec, function(dose) {

  map_df(c("Male", "Female"), function(sex) {

    pars <- if (sex == "Male") pars_m else pars_f

    out <- solve_pbtk(
      chem.cas = "1763-23-1",
      days = max(time_vec),
      doses.per.day = 1,
      daily.dose = dose,
      output.units = "uM",
      parameters = pars
    )

    map_df(tissues_all, function(tiss) {

      col_name <- tissue_to_col(tiss)
      if (!(col_name %in% colnames(out))) return(NULL)

      pred <- approx(
        x = out[, "time"],
        y = out[, col_name],
        xout = time_vec,
        rule = 2
      )

      tibble(
        Dose = dose,
        Time = pred$x,
        Tissue = tiss,
        Sex = sex,
        Predicted_Conc_uM = pred$y
      )
    })
  })
})

# Join model predictions with observed data 
comparison <- pfos_obs %>%
  left_join(predictions, by = c("Dose", "Time", "Tissue"))

# Separate predicted-only data for tissues without observations
model_only <- predictions %>%
  anti_join(pfos_obs, by = c("Dose", "Time", "Tissue"))

pfos_obs <- pfos_obs %>%
  mutate(uM = as.numeric(trimws(uM)),
        Tissue = factor(Tissue, levels = tissues_all)) 

predictions <- predictions %>%
  mutate(
    Tissue = factor(Tissue, levels = tissues_all))

pfos_obs$Dose_Time <- paste0(pfos_obs$Dose, " (", pfos_obs$Time, ")")
predictions$Dose_Time <- paste0(predictions$Dose, " (", predictions$Time, ")")
predictions <- subset(predictions, !(Dose_Time %in% c("0.166 (28)", "0.5 (28)", "1 (28)")))


plot_pfos <- ggplot() +
    # ---- Observed (dose-colored) ----
  geom_jitter(
    data = pfos_obs %>% filter(Time %in% c(28, 56)),
    aes(x = factor(Dose_Time), y = uM, shape = factor(Sex), color = factor(Dose), fill = factor(Dose)),
    size = 2, alpha = 0.5, width = 0.1, stroke = 1,
  ) +
  geom_point(
    data = predictions %>% filter(Time %in% c(28, 56)),
    aes( x =factor(Dose_Time), y = Predicted_Conc_uM, shape = Sex),
    fill = "red",color = "red", size = 2, 
  ) +
  facet_wrap(~ Tissue, scales = "free_y") +
  scale_color_manual(
    name = "Color",
    values = c(custom_colors_named)
  ) +
  scale_fill_manual(
    name = "Dose",
    values = custom_colors_named
  ) +
  scale_shape_manual(
    name = "Sex",
    values = shape_map
  ) +
  labs(
    title = "Predicted vs Observed PFOS Concentrations (PBTK)",
    x = "Dose (mg/kg)",
    y = "PFOS Concentration (µM)"
  ) +
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank())

print(plot_pfos)

ggsave(filename = "../plots/pfos_pbtk.png", plot = plot_pfos, width = 12.5, height = 7.5, dpi = 300,bg = "white")


predictions <- subset(predictions, Tissue %in% c("Plasma", "Liver")) #add kidney later

obs_vs_pred_table <- pfos_obs %>%
  inner_join(
    predictions,
    by = c("Dose_Time", "Tissue", "Sex")
  ) %>%
  mutate(
    diff_uM      = Predicted_Conc_uM - uM,
    fold_diff    = Predicted_Conc_uM / uM,
    percent_diff = 100 * diff_uM / uM
  ) %>%
  select(
    Dose_Time,
    Tissue,
    Sex,
    Observed_uM  = uM,
    Predicted_uM = Predicted_Conc_uM,
    diff_uM,
    fold_diff,
    percent_diff
  ) %>%
  arrange(Tissue, desc(fold_diff))


tissue_summary <- obs_vs_pred_table %>%
  group_by(Tissue) %>%
  summarise(
    n = n(),
    mean_diff_uM = mean(diff_uM, na.rm = TRUE),
    mean_diff_uM = mean(diff_uM, na.rm = TRUE),
    mean_fold  = mean(fold_diff, na.rm = TRUE),
    times_lower = ifelse(mean_fold < 1, 1 / mean_fold, NA_real_),
    times_higher = ifelse(mean_fold > 1, mean_fold, NA_real_),
    .groups = "drop"
  )

tissue_summary
replicate_summary <- pfos_obs%>%
  group_by(Dose, Time, Tissue) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```

###PFOA Plasma PBTK solve_pbtk (class.exclude =F)
```{r}
shape_map <- c(`Male` = 24, `Female` = 21)
pfoa_obs <- pfas_obs_all %>%
  filter(PFAS_type == "PFOA",
    Tissue != "Feces")

dose_vec <- unique(pfoa_obs$Dose)
time_vec <- unique(pfoa_obs$Time)
sim_days <- max(time_vec)
tissues_all <- c("Plasma", "Liver", "Kidney", "Lung", "Gut", "Rest")

# Function to map tissue names to PBTK model column names
tissue_to_col <- function(tissue) {
  switch(tissue,
         Plasma = "Cplasma",
         Liver = "Cliver",
         Kidney = "Ckidney",
         Lung = "Clung",
         Gut = "Cgut",
         Rest = "Crest")
}
# Base parameterization (run once)
pars_base <- parameterize_pbtk(
  chem.cas = "335-67-1",
  species = "Mouse",
  dosingadj = "Oral",
  class.exclude = FALSE,
  suppress.messages = TRUE,
  default.to.human = TRUE
)

# ---- Male parameters ----
pars_m <- pars_base
pars_m$Vdist <- 0.1805
pars_m$kelim <- 0.001331 * 1.5 #https://pmc.ncbi.nlm.nih.gov/articles/PMC4464984/
pars_m$Funbound.plasma <- 0.0142
pars_m$Rblood2plasma <- 0.9047
pars_m$Caco2.Pab <- 1.6
pars_m$Clmetabolismc <- pfoa_clearance_m
pars_m$Fabsgut <- 0.9798 #https://www.ncbi.nlm.nih.gov/books/NBK614278/
pars_m$kgutabs <- 1.572
  
# ---- Female parameters ----
pars_f <- pars_base
pars_f$Vdist <- 0.1805
pars_f$kelim <- 0.001851 * 1.5 #https://pmc.ncbi.nlm.nih.gov/articles/PMC4464984/
pars_f$Funbound.plasma <- 0.0142
pars_f$Rblood2plasma <- 0.9047
pars_f$Caco2.Pab <- 1.6
pars_f$Clmetabolismc <- pfoa_clearance_f
pars_f$Fabsgut <- 0.9798 #https://www.ncbi.nlm.nih.gov/books/NBK614278/
pars_f$kgutabs <- 1.572

pars_f_df <- data.frame(
  Parameter = names(pars_f),
  Female = unlist(pars_f)
)

pars_m_df <- data.frame(
  Parameter = names(pars_m),
  Male = unlist(pars_m)
)

pars <- full_join(pars_f_df, pars_m_df, by = "Parameter")

# Write both parameter sets
write.csv(pars, "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Output/pars_pfoa_pbtk.csv")

# Run model and get predictions
predictions <- map_df(dose_vec, function(dose) {

  map_df(c("Male", "Female"), function(sex) {

    pars <- if (sex == "Male") pars_m else pars_f

    out <- solve_pbtk(
      chem.cas = "335-67-1",
      days = max(time_vec),
      doses.per.day = 1,
      daily.dose = dose,
      output.units = "uM",
      parameters = pars
    )

    map_df(tissues_all, function(tiss) {

      col_name <- tissue_to_col(tiss)
      if (!(col_name %in% colnames(out))) return(NULL)

      pred <- approx(
        x = out[, "time"],
        y = out[, col_name],
        xout = time_vec,
        rule = 2
      )

      tibble(
        Dose = dose,
        Time = pred$x,
        Tissue = tiss,
        Sex = sex,
        Predicted_Conc_uM = pred$y
      )
    })
  })
})

# Join model predictions with observed data 
comparison <- pfoa_obs %>%
  left_join(predictions, by = c("Dose", "Time", "Tissue"))

# Separate predicted-only data for tissues without observations
model_only <- predictions %>%
  anti_join(pfoa_obs, by = c("Dose", "Time", "Tissue"))

pfoa_obs <- pfoa_obs %>%
    mutate(uM = as.numeric(trimws(uM)),
    Tissue = factor(Tissue, levels = tissues_all)) 

predictions <- predictions %>%
  mutate(
    Tissue = factor(Tissue, levels = tissues_all))


pfoa_obs$Dose_Time <- paste0(pfoa_obs$Dose, " (", pfoa_obs$Time, ")")
predictions$Dose_Time <- paste0(predictions$Dose, " (", predictions$Time, ")")
predictions <- subset(predictions, !(Dose_Time %in% c("0.166 (28)", "0.5 (28)", "1 (28)")))

plot_pfoa <- ggplot() +
    # ---- Observed (dose-colored) ----
  geom_jitter(
    data = pfoa_obs %>% filter(Time %in% c(28, 56)),
    aes(x = factor(Dose_Time), y = uM, shape = factor(Sex), color = factor(Dose), fill = factor(Dose)),
    size = 2, alpha = 0.5, width = 0.1, stroke = 1, 
  ) +
  geom_point(
    data = predictions %>% filter(Time %in% c(28, 56)),
    aes(x = factor(Dose_Time), y = Predicted_Conc_uM, shape = Sex),
    fill = "red",color = "red", size = 2, 
  ) +
  facet_wrap(~ Tissue, scales = "free_y") +
  scale_color_manual(
    name = "Color",
    values = c(custom_colors_named)
  ) +
  scale_fill_manual(
    name = "Dose",
    values = custom_colors_named
  ) +
  scale_shape_manual(
    name = "Sex",
    values = shape_map
  ) +
  labs(
    title = "Predicted vs Observed PFOS Concentrations (PBTK)",
    x = "Dose (mg/kg)",
    y = "PFOA Concentration (µM)"
  ) +
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank())

print(plot_pfoa)

ggsave(filename = "../plots/pfoa_pbtk.png", plot = plot_pfoa, width = 12.5, height = 7.5, dpi = 300,bg = "white")

obs_vs_pred_table <- pfoa_obs %>%
  inner_join(
    predictions,
    by = c("Dose_Time", "Tissue", "Sex")
  ) %>%
  mutate(
    diff_uM      = Predicted_Conc_uM - uM,
    fold_diff    = Predicted_Conc_uM / uM,
    percent_diff = 100 * diff_uM / uM
  ) %>%
  select(
    Dose_Time,
    Tissue,
    Sex,
    Observed_uM  = uM,
    Predicted_uM = Predicted_Conc_uM,
    diff_uM,
    fold_diff,
    percent_diff
  ) %>%
  arrange(Tissue, desc(fold_diff))


tissue_summary <- obs_vs_pred_table %>%
  group_by(Tissue) %>%
  summarise(
    n = n(),
    mean_diff_uM = mean(diff_uM, na.rm = TRUE),
    mean_diff_uM = mean(diff_uM, na.rm = TRUE),
    mean_fold  = mean(fold_diff, na.rm = TRUE),
    times_lower = ifelse(mean_fold < 1, 1 / mean_fold, NA_real_),
    times_higher = ifelse(mean_fold > 1, mean_fold, NA_real_),
    .groups = "drop"
  )
tissue_summary

replicate_summary <- pfoa_obs%>%
  group_by(Dose, Time, Tissue) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```

##PFOS Clearance 
```{r}
shape_map <- c(`Male` = 24, `Female` = 21)

#convert to ml/day/kg
clearance_pred_m <- 0.0002063 * 24* 1000
clearance_pred_f <- 0.0002209 * 24* 1000

clearance <- mean(c(clearance_pred_f, clearance_pred_m), na.rm = TRUE)

  
pfos_obs <- pfas_obs_all %>%
  filter(PFAS_type == "PFOS")

fecal_obs <- pfos_obs %>%
  filter(Tissue == "Feces") %>% 
   filter(Group != "Vehicle") %>%
  select(Dose, Time, PFAS_conc, Mouse.ID, Sex) %>%
  mutate(
    # Convert ng/g → ng/kg feces
    ng_kg_feces = PFAS_conc * 1000,

    # Fecal excretion rate (kg feces / h / kg bw)
    feces_rate_kg_h_kg = 0.08 / 24,

    # Final excretion rate: ng / h / kg bw
    ng_h_kg = ng_kg_feces * feces_rate_kg_h_kg
  ) %>%
  group_by(Dose, Time)

plasma_obs <- pfos_obs %>%
  filter(Tissue == "Plasma") %>%
  select(Dose, Time, ng_L, Mouse.ID, Sex)

clearance_fecal <- fecal_obs %>%
  left_join(plasma_obs, by = c("Mouse.ID", "Dose", "Time", "Sex")) %>%
  mutate(
    CL_L_h_kg = ng_h_kg / ng_L)

#Convert L/h/kg → mL/day/kg

clearance_fecal <- clearance_fecal %>%
  mutate(
    CL_ml_day_kg = CL_L_h_kg * 24 * 1000)

clearance_fecal$Dose_Time <- paste0(clearance_fecal$Dose, " (", clearance_fecal$Time, ")")


p <- ggplot() +
    geom_jitter(
    data = clearance_fecal,
    aes(x = factor(Dose_Time), y = CL_ml_day_kg, color = factor(Dose), fill = factor(Dose), shape = factor(Sex)),
    size = 2, alpha = 0.5, width = 0.1, stroke = 1 
    ) +
  labs(
    title = "PFOS —Clearance"
  ) +
    geom_hline(yintercept = clearance_pred_f, linetype = "dashed", color = "red", linewidth =0.8) +
  geom_hline(yintercept = clearance_pred_m, linetype = "dashed", color = "blue", linewidth =0.8) +
  scale_color_manual(
  name = "Color",
  values = c(custom_colors_named)
  ) +
  scale_fill_manual(
  name = "Dose",
  values = custom_colors_named
  ) +
  scale_shape_manual(
  name = "Sex",
  values = shape_map
  ) +
  theme_minimal() +
 coord_cartesian(ylim = c(0, 12.5)) + 
  theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "b",
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank())
print(p)
ggsave(filename = "../plots/pfos_clerance.png", plot = p, width = 6, height = 3, dpi = 300,bg = "white")

mean <- clearance_fecal %>%
  ungroup() %>%
  summarise(
    n = n(),
    mean_CL_ml_day_kg = mean(CL_ml_day_kg, na.rm = TRUE)
  )
FC <- clearance/mean$mean_CL_ml_day_kg

replicate_summary <- clearance_fecal%>%
  group_by(Dose, Time) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```
##PFOA Clearance
```{r}
#convert to ml/day/kg
clearance_pred_m <- pfoa_clearance_m * 24* 1000
clearance_pred_f <- pfoa_clearance_f * 24* 1000
clearance <- mean(c(clearance_pred_f, clearance_pred_m), na.rm = TRUE)


pfoa_obs <- pfas_obs_all %>%
  filter(PFAS_type == "PFOA")

fecal_obs <- pfoa_obs %>%
  filter(Tissue == "Feces") %>% 
  filter(Group != "Vehicle") %>% 
  select(Dose, Time, PFAS_conc, Mouse.ID, Sex) %>%
  mutate(
    # Convert ng/g → ng/kg feces
    ng_kg_feces = PFAS_conc * 1000,

    # Fecal excretion rate (kg feces / h / kg bw)
    feces_rate_kg_h_kg = 0.08 / 24,

    # Final excretion rate: ng / h / kg bw
    ng_h_kg = ng_kg_feces * feces_rate_kg_h_kg
  ) %>%
  group_by(Dose, Time)

plasma_obs <- pfoa_obs %>%
  filter(Tissue == "Plasma") %>%
  select(Dose, Time, ng_L, Mouse.ID, Sex)

clearance_fecal <- fecal_obs %>%
  left_join(plasma_obs, by = c("Mouse.ID", "Dose", "Time", "Sex")) %>%
  mutate(
    CL_L_h_kg = ng_h_kg / ng_L)


#Convert L/h/kg → mL/day/kg

clearance_fecal <- clearance_fecal %>%
  mutate(
    CL_ml_day_kg = CL_L_h_kg * 24 * 1000)
clearance_fecal$Dose_Time <- paste0(clearance_fecal$Dose, " (", clearance_fecal$Time, ")")

p <- ggplot() +
    geom_jitter(
    data = clearance_fecal,
    aes(x = factor(Dose_Time), y = CL_ml_day_kg, color = factor(Dose), fill = factor(Dose), shape = factor(Sex)),
    size = 2, alpha = 0.5, width = 0.1, stroke = 1 
    ) +
    labs(
    title = "PFOA —Clearance"
  ) +
  geom_hline(yintercept = clearance_pred_f, linetype = "dashed", color = "red", linewidth =0.8) +
  geom_hline(yintercept = clearance_pred_m, linetype = "dashed", color = "blue", linewidth =0.8) +
  scale_color_manual(
  name = "Color",
  values = c(custom_colors_named)
  ) +
  scale_fill_manual(
  name = "Dose",
  values = custom_colors_named
  ) +
  scale_shape_manual(
  name = "Sex",
  values = shape_map
  ) +
  theme_minimal() +
 coord_cartesian(ylim = c(0, 12.5)) +  
  theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "b",
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank())
print(p)
ggsave(filename = "../plots/pfoa_clerance.png", plot = p, width = 6, height = 3, dpi = 300,bg = "white")



mean <- clearance_fecal %>%
  ungroup() %>%
  summarise(
    n = n(),
    mean_CL_ml_day_kg = mean(CL_ml_day_kg, na.rm = TRUE)
  )

FC <- clearance/mean$mean_CL_ml_day_kg

replicate_summary <- clearance_fecal%>%
  group_by(Dose, Time) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))
```



#% of dose feces PFOS
```{r}
df_pfos <- pfos_obs %>%
  filter(Tissue == "Feces", Group != "Vehicle") %>%
  select(Dose, Time, PFAS_conc, Mouse.ID, Sex) %>%
  mutate(
    Chemical = "PFOS",
    ng_kg_feces = PFAS_conc * 1000,
    feces_rate_kg_h_kg = 0.08 / 24,
    ng_h_kg = ng_kg_feces * feces_rate_kg_h_kg,
    Feces_ng_kg = ng_h_kg * 24 * Time,
    Admin_Dose_ng_kg = Dose * Time * 1e6,
    Percent_Dose_Feces = (Feces_ng_kg / Admin_Dose_ng_kg) * 100
  )

## ---- PFOA ----
df_pfoa <- pfoa_obs %>%
  filter(Tissue == "Feces", Group != "Vehicle") %>%
  select(Dose, Time, PFAS_conc, Mouse.ID, Sex) %>%
  mutate(
    Chemical = "PFOA",
    ng_kg_feces = PFAS_conc * 1000,
    feces_rate_kg_h_kg = 0.08 / 24,
    ng_h_kg = ng_kg_feces * feces_rate_kg_h_kg,
    Feces_ng_kg = ng_h_kg * 24 * Time,
    Admin_Dose_ng_kg = Dose * Time * 1e6,
    Percent_Dose_Feces = (Feces_ng_kg / Admin_Dose_ng_kg) * 100
  )

## ---- Combine ----
df_all <- bind_rows(df_pfos, df_pfoa)

shape_map <- c(`Male` = 24, `Female` = 21)
custom_colors_named <- c(
  "PFOS"   = "#f2844b",
  "PFOA"   = "#6a00a8")

df_all$Dose_Time <- paste0(df_all$Dose, " (", df_all$Time, ")")

df_avg <- df_all %>%
  group_by(Chemical, Dose_Time) %>%
  summarise(
    Mean_Percent_Dose_Feces = mean(Percent_Dose_Feces),
    .groups = "drop"
  )

p <- ggplot(df_all,
       aes(
         x = factor(Dose_Time),
         y = Percent_Dose_Feces,
         color = Chemical,
         fill  = Chemical,
         shape = Sex,
         group = interaction(Mouse.ID, Chemical)
       )) +
  geom_point(
   size = 2, alpha = 0.5, width = 0.1, stroke = 1
  ) +
  geom_line(
    data = df_avg,
    aes(
      x = factor(Dose_Time),
      y = Mean_Percent_Dose_Feces,
      group = Chemical,
      color = Chemical
    ),
    inherit.aes = FALSE,
    linewidth = 0.8,
    linetype = "dashed"
  ) +
  scale_color_manual(
    name = "Chemical",
    values = custom_colors_named
  ) +
  scale_fill_manual(
    name = "Chemical",
    values = custom_colors_named
  ) +
  scale_shape_manual(
    name = "Sex",
    values = shape_map
  ) +
  
  labs(
    x = NULL,
    y = "% of administered dose in feces"
  ) +
  
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none",
    panel.grid.major = element_line(linewidth = 0.5),
    panel.grid.minor = element_blank()
  )
print(p)
ggsave(filename = "../plots/percent_of_dose.png", plot = p, width = 6, height = 3, dpi = 300,bg = "white")

replicate_summary <- df_all %>%
  group_by(Dose_Time, Chemical) %>%  
  summarise(n = n(), .groups = "drop")
min_n <- min(replicate_summary$n)
max_n <- max(replicate_summary$n)
cat(sprintf("n = %d–%d mice/group\n", min_n, max_n))

mean <- df_all %>%
  group_by(Chemical) %>%
  summarise(
    n = n(),
    Percent_Dose_Feces = mean(Percent_Dose_Feces, na.rm = TRUE)
  )
```


#Human equvilant dose using httk 2.7.2
#CHMS
```{r}
#load in total data in ng/ml 2018-19, total, 3-79
chms <- data.frame(
  Compound = c("PFOS", "PFOA"),
  GeometricMean = c(2.5, 1.2 ),
  CI_Lower = c(2.3, 1.1),
  CI_Upper = c(2.8, 1.3)
)

chms <- chms %>%
  mutate(
    # ng/mL → mg/L
    C_plasma_mg_L = GeometricMean * 1e-3,

    CL_L_kg_day = case_when(
      #pfas.clearance httk function imported as L/H/KG times by 24 
      Compound == "PFOS" ~ 4.7355e-06 *24	, 
      Compound == "PFOA" ~ 5.5615e-06*24
    ),

    Intake_mg_kg_day = C_plasma_mg_L * CL_L_kg_day,

    Intake_low = CI_Lower * 1e-3 * CL_L_kg_day,
    Intake_high = CI_Upper * 1e-3 * CL_L_kg_day
  )

#https://pmc.ncbi.nlm.nih.gov/articles/PMC1964923/
#imported as ng/ml  arithmetric mean 
firefighters <- data.frame(
  Compound = c("PFOS", "PFOA"),
  GeometricMean = c(799, 691),
  CI_Lower = c(145, 72),
  CI_Upper = c(3490, 5200)
)
firefighters <- firefighters %>%
  mutate(
    # ng/mL → mg/L
    C_plasma_mg_L = GeometricMean * 1e-3,

    CL_L_kg_day = case_when(
        Compound == "PFOS" ~ 4.7355e-06 *24	, 
      Compound == "PFOA" ~ 5.5615e-06*24
    ),

    Intake_mg_kg_day = C_plasma_mg_L * CL_L_kg_day,

    Intake_low = CI_Lower * 1e-3 * CL_L_kg_day,
    Intake_high = CI_Upper * 1e-3 * CL_L_kg_day
  )
combined <- rbind(firefighters, chms)
```

##PFOS Oral equiv
```{r}

shape_map <- c(`Male` = 24, `Female` = 21)
custom_colors_named <- c(
  "0"   = "#330597",
  "0.166"   = "#b12a90",
  "0.5"     = "#d35171",
  "1"       = "#f68f44",
  "1.5"     = "#fec029")


pfos_obs <- pfas_obs_all %>%
  filter(PFAS_type == "PFOS") %>%
  mutate(uM = as.numeric(trimws(uM)))

#I am using averaged PFAS conc in the plasma per dose and time group
plasma_obs <- pfos_obs %>%
  filter(Tissue == "Plasma") %>%
  select(Dose, Time, uM)
plasma_obs_avg_uM <- plasma_obs %>%
  group_by(Dose, Time) %>%
  summarise(avg_uM = mean(uM, na.rm = TRUE))

dose_vec <- unique(plasma_obs_avg_uM$avg_uM)

oral_equiv_results <- plasma_obs_avg_uM %>%
  rowwise() %>%
  mutate(
    # Get human PFOS PK parameters (1-compartment PFAS model)
    pars = list(parameterize_pfas1comp(
      chem.cas = "1763-23-1",
      species = "Human",
      dosingadj = "Oral"
    )),

      pars = list({pars$Clint <- 0;   #https://pmc.ncbi.nlm.nih.gov/articles/PMC11435625/#sec3-toxics-12-00672
      pars$Rblood2plasma <- 0.588; #httk 
      pars$Vdist <- 0.23		#httk load pfas
      pars$Funbound.plasma <-  0.000753; # file:///C:/Users/aloan/Downloads/toxics-12-00253.pdf
      pars$Caco2.Pab <- 1.6; #httk default with function
      pars$kelim <- 2.059e-05; pars}), # httk load pfas
    view(pars),
    write.csv(pars, "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Output/pars_pfos_hed.csv"),
    oral_equiv_mgkgd = calc_mc_oral_equiv(
      species = "Human",
      chem.cas = "1763-23-1",
      conc = avg_uM,
      model = "pfas1compartment",
      input.units = "uM",
      output.units = "mgpkgpday",
      samples = 2000,
      parameters = pars
    )
  ) %>%
  ungroup() %>%
  select(Dose, Time, avg_uM, oral_equiv_mgkgd)



pfos_biodata <- combined %>%
  filter(Compound == "PFOS") 

oral_equiv_results$Dose_Time <- paste0(oral_equiv_results$Dose, " (", oral_equiv_results$Time, ")")

p <- ggplot() +
  # Points: colored by Dose
  geom_point(
    data = oral_equiv_results, 
    aes(
      x = factor(Dose_Time),
      y = oral_equiv_mgkgd,
      color = factor(Dose),
      fill  = factor(Dose),
    ), alpha = 0.6, size = 3, stroke = 1
  ) +
geom_hline(
  data = pfos_biodata,
  aes(yintercept = Intake_mg_kg_day),
  color = c("red", "blue"),
  linetype = "dashed",
  linewidth = 0.8
)+
  # Horizontal lines: colored by Source
geom_rect(
  data = pfos_biodata,
  aes(
    ymin = Intake_low,
    ymax = Intake_high
  ),
  xmin = -Inf,
  xmax = Inf,
  fill = c("red", "blue"),
  alpha = 0.4
) +
  # Log10 y-axis
 scale_y_log10(
  limits = c(1e-7, 1e-1),
  breaks = c(1e-6, 1e-5, 1e-4, 1e-3, 1e-2)
) +
  # Point colors for Dose
  scale_color_manual(
    name   = "Dose (mg/kg/day)",
    values = custom_colors_named
  ) +
  scale_fill_manual(
  name = "Dose",
  values = custom_colors_named
  ) +
  labs(
    title = "Predicted vs Observed PFOS",
    x = "Dose (mg/kg/day)",
    y = "mg/kg/day"
  ) +

  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none",
    panel.grid.major = element_line(linewidth = 0.4),
    panel.grid.minor = element_blank()
  )

print(p)

ggsave(filename = "../plots/pfos_hed.png", plot = p, width = 9, height = 3, dpi = 300,bg = "white")
```


##PFOA Oral equiv
```{r}

pfoa_obs <- pfas_obs_all %>%
  filter(PFAS_type == "PFOA") %>%
  mutate(uM = as.numeric(trimws(uM)))

#I am using averaged PFAS conc in the plasma per dose and time group
plasma_obs <- pfoa_obs %>%
  filter(Tissue == "Plasma") %>%
  select(Dose, Time, uM)
plasma_obs_avg_uM <- plasma_obs %>%
  group_by(Dose, Time) %>%
  summarise(avg_uM = mean(uM, na.rm = TRUE))

dose_vec <- unique(plasma_obs_avg_uM$avg_uM)

oral_equiv_results <- plasma_obs_avg_uM %>%
  rowwise() %>%
  mutate(
    # Get human PFOA PK parameters (1-compartment PFAS model)
    pars = list(parameterize_pfas1comp(
      chem.cas = "335-67-1",
      species = "Human",
      dosingadj = "Oral",
      suppress.messages = TRUE
    )),
    view(pars),
      pars = list({pars$Clint <- 0;   #https://pmc.ncbi.nlm.nih.gov/articles/PMC11435625/#sec3-toxics-12-00672
      pars$Rblood2plasma <- 0.9047; #httk 
      pars$Vdist <- 0.17	#httk load pfas
      pars$Caco2.Pab <- 1.6; #httk default with function
      pars$Funbound.plasma <- 0.00245;   # file:///C:/Users/aloan/Downloads/toxics-12-00253.pdf
      pars$kelim <- 3.2715e-05 ; pars}), #httk load pfas
    
      view(pars),
    write.csv(pars, "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Output/pars_pfoa_hed.csv"),
    # Calculate human oral equivalent dose
    oral_equiv_mgkgd = calc_mc_oral_equiv(
      species = "Human",
      chem.cas = "1763-23-1",
      conc = avg_uM,
      model = "pfas1compartment",
      input.units = "uM",
      output.units = "mgpkgpday",
      samples = 2000,
      parameters = pars
    )
  ) %>%
  ungroup() %>%
  select(Dose, Time, avg_uM, oral_equiv_mgkgd)


oral_equiv_results

pfoa_biodata <- combined %>%
  filter(Compound == "PFOA" ) 

oral_equiv_results$Dose_Time <- paste0(oral_equiv_results$Dose, " (", oral_equiv_results$Time, ")")

p <- ggplot() +
  # Points: colored by Dose
  geom_point(
    data = oral_equiv_results, 
    aes(
      x = factor(Dose_Time),
      y = oral_equiv_mgkgd,
      color = factor(Dose),
      fill  = factor(Dose),
    ), alpha = 0.6, size = 3, stroke = 1
  ) +
geom_hline(
  data = pfoa_biodata,
  aes(yintercept = Intake_mg_kg_day),
  color = c("red", "blue"),
  linetype = "dashed",
  linewidth = 0.8
)+
  # Horizontal lines: colored by Source
geom_rect(
  data = pfoa_biodata,
  aes(
    ymin = Intake_low,
    ymax = Intake_high
  ),
  xmin = -Inf,
  xmax = Inf,
  fill = c("red", "blue"),
  alpha = 0.4
) +
  # Log10 y-axis
 scale_y_log10(
  limits = c(1e-7, 1e-1),
  breaks = c(1e-6, 1e-5, 1e-4, 1e-3, 1e-2)
) +

  # Point colors for Dose
  scale_color_manual(
    name   = "Dose (mg/kg/day)",
    values = custom_colors_named
  ) +
  scale_fill_manual(
  name = "Dose",
  values = custom_colors_named
  ) +
  labs(
    title = "Predicted vs Observed PFOA",
    x = "Dose (mg/kg/day)",
    y = "mg/kg/day"
  ) +

  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none",
    panel.grid.major = element_line(linewidth = 0.4),
    panel.grid.minor = element_blank()
  )

print(p)
ggsave(filename = "../plots/pfoa_hed.png", plot = p, width = 9, height = 3, dpi = 300,bg = "white")
```



#Genra
##Elbow calc
```{r}
#Load in analog info
RA_pfoa <-read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Input/genra_20251208_PFOA.csv")
RA_pfos <-read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Input/genra_20251210_PFOS.csv")

RA_pfoa <- RA_pfoa %>%
  mutate(Chemical = "PFOA")


RA_pfos <- RA_pfos %>%
  mutate(Chemical = "PFOS")


genra_combined<- rbind(RA_pfoa, RA_pfos) %>%
  drop_na(similarity)
pfos_sorted <- genra_combined %>%
  filter(Chemical == "PFOS") %>%
  arrange(desc(similarity)) %>%
  mutate(rank = row_number())

ggplot(pfos_sorted, aes(x = rank, y = similarity)) +
  geom_point() +
  geom_line() +
  labs(x = "Rank", y = "Similarity", title = "Similarity Elbow Plot") +
  theme_minimal()


# Get coordinates
x <- pfos_sorted$rank
y <- pfos_sorted$similarity

# Line from first to last point
x1 <- min(x); y1 <- max(y)
x2 <- max(x); y2 <- min(y)

# Function to calculate distance from a point to a line
point_line_distance <- function(x0, y0, x1, y1, x2, y2) {
  abs((y2 - y1)*x0 - (x2 - x1)*y0 + x2*y1 - y2*x1) / sqrt((y2 - y1)^2 + (x2 - x1)^2)
}

distances <- point_line_distance(x, y, x1, y1, x2, y2)
elbow_index <- which.max(distances)
elbow_similarity <- y[elbow_index]

elbow_index
elbow_similarity

pfoa_sorted <- genra_combined %>%
  filter(Chemical == "PFOA") %>%
  arrange(desc(similarity)) %>%
  mutate(rank = row_number())

ggplot(pfoa_sorted, aes(x = rank, y = similarity)) +
  geom_point() +
  geom_line() +
  labs(x = "Rank", y = "Similarity", title = "Similarity Elbow Plot") +
  theme_minimal()


# Get coordinates
x <- pfoa_sorted$rank
y <- pfoa_sorted$similarity

# Line from first to last point
x1 <- min(x); y1 <- max(y)
x2 <- max(x); y2 <- min(y)

# Function to calculate distance from a point to a line
point_line_distance <- function(x0, y0, x1, y1, x2, y2) {
  abs((y2 - y1)*x0 - (x2 - x1)*y0 + x2*y1 - y2*x1) / sqrt((y2 - y1)^2 + (x2 - x1)^2)
}

distances <- point_line_distance(x, y, x1, y1, x2, y2)
elbow_index <- which.max(distances)
elbow_similarity <- y[elbow_index]

elbow_index
elbow_similarity

```
##Inital plot of 5k chemicals
```{r}
label_lookup <- c(
  "DTXSID40892486" = "PFOA",
  "DTXSID3031864"  = "PFOS",
  "DTXSID4059916"  = "PFBA",
  "DTXSID6062599"  = "PFPeA",
  "DTXSID3031862"  = "PFHxA",
  "DTXSID1037303"  = "PFHpA",
  "DTXSID8031863"  = "PFNA",
  "DTXSID3031860"  = "PFDA",
  "DTXSID8047553"  = "PFUdA",
  "DTXSID8031861"  = "PFDoA",
  "DTXSID90868151" = "PFTrDA",
  "DTXSID3059921"  = "PFTeDA",
  "DTXSID60873015" = "PFBS",
  "DTXSID8062600"  = "PFPeS",
  "DTXSID7040150"  = "PFHxS",
  "DTXSID8059920"  = "PFHpS",
  "DTXSID8071356"  = "PFNS",
  "DTXSID00873014" = "PFDS",
  "DTXSID30891564" = "4:2 FTS",
  "DTXSID6067331"  = "6:2 FTS",
  "DTXSID00192353" = "8:2 FTS",
  "DTXSID10624392" = "N_MeFOSAA",
  "DTXSID60892504" = "N_EtFOSAA",
  "DTXSID3038939"  = "FOSA",
  "DTXSID2060032"  = "DONA",
  "DTXSID70880215" = "HFPO-DA"
)

pfos<- ggplot() +
  geom_point(data = genra_combined %>% 
                filter(Chemical =="PFOS"),
             aes(x = fct_reorder(dsstox_sid, similarity, .desc = TRUE), y = similarity, color = similarity), alpha = 0.8, size = 4) +
  geom_text_repel(
  data = genra_combined %>%
    filter(Chemical == "PFOS",
           dsstox_sid %in% names(label_lookup)),
  aes(
    x = fct_reorder(dsstox_sid, similarity, .desc = TRUE),
    y = similarity,
    label = label_lookup[dsstox_sid]
  ),
  size = 8,
  max.overlaps = Inf,
  force = 4,
  box.padding = 2,
  point.padding = 0.6,
  min.segment.length = 0,
  segment.size = 1.5,
  max.time = 2
)+
  facet_wrap(~ Chemical, scales = "free_y") +
      scale_color_viridis(option = "plasma", direction = -1) +
  labs(
    title = "NULL",
    x = "NULL",
    y = "Similarity",
    color = "Similarity"
  ) +
    geom_hline(yintercept = 0.4, linetype = "dashed", color = "red",  linewidth = 0.8) +
  ylim(0, 1) +
  theme_minimal() +
  theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "b",
      axis.line = element_line(color = "black", linewidth = 0.6),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank())
print(pfos)
ggsave(filename = "../plots/pfos_genra5k.png", plot = pfos, width = 20, height = 6, dpi = 300,bg = "white")


pfoa <-ggplot() +
  geom_point(data = genra_combined %>% 
                filter(Chemical =="PFOA"),
             aes(x = fct_reorder(dsstox_sid, similarity, .desc = TRUE), y = similarity, color = similarity),
       alpha = 0.8, size = 4) +
    geom_text_repel(
  data = genra_combined %>%
    filter(Chemical == "PFOA",
           dsstox_sid %in% names(label_lookup)),
  aes(
    x = fct_reorder(dsstox_sid, similarity, .desc = TRUE),
    y = similarity,
    label = label_lookup[dsstox_sid]
  ),
  size = 8,
  max.overlaps = Inf,
  force = 4,
  box.padding = 2,
  point.padding = 0.6,
  min.segment.length = 0,
  segment.size = 1.5,
  max.time = 2
)+
  facet_wrap(~ Chemical, scales = "free_y") +
      scale_color_viridis(option = "plasma", direction = -1) +
  labs(
    title = "NULL",
    x = "NULL",
    y = "Similarity",
    color = "Carbon lenght"
  ) +
    geom_hline(yintercept = 0.3333333, linetype = "dashed", color = "red",  linewidth = 0.8) +
  ylim(0, 1) +
  theme_minimal() +
  theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "none",
      panel.grid.major = element_blank(),
        axis.line = element_line(color = "black", linewidth = 0.6),
      panel.grid.minor = element_blank())
print(pfoa)
ggsave(filename = "../plots/pfoa_genra5k.png", plot = pfoa, width = 20, height = 6, dpi = 300,bg = "white")
```

## PFOA TSNE
```{r}
#Subset Genra
genra_combined_pfoa <- genra_combined %>%
  filter(
    Chemical == "PFOA"
  )               

set.seed(123)  # reproducibility

sim <- genra_combined_pfoa$similarity
#make small things more similar
dist_matrix <- as.dist(1 - sim)
tsne_out_pfos <- Rtsne(dist_matrix, dims = 2, perplexity = 100, verbose = TRUE)

tsne_df_pfoa <- genra_combined_pfoa %>%
  mutate(tSNE1 = tsne_out_pfos$Y[,1],
         tSNE2 = tsne_out_pfos$Y[,2])


tsnepfoa <- ggplot(tsne_df_pfoa, aes(x = tSNE1, y = tSNE2, label = dsstox_sid, color = similarity)) +
  geom_point(alpha = 0.8, size = 4) +
  scale_color_viridis(option = "plasma", direction = -1) +
  theme_minimal() +
  theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "right",
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank())
print(tsnepfoa)
ggsave(filename = "../plots/pfoa_tsne.png", plot = tsnepfoa, width = 7, height = 5, dpi = 300,bg = "white")
```


##PFOS TSNE
```{r}
genra_combined_pfos <- genra_combined %>%
  filter(
    Chemical == "PFOS"
  )

set.seed(123)  # reproducibility

sim <- genra_combined_pfos$similarity
#make small things more similar
dist_matrix <- as.dist(1 - sim)
tsne_out_pfos <- Rtsne(dist_matrix, dims = 2, perplexity = 100, verbose = TRUE)

tsne_df_pfos <- genra_combined_pfos %>%
  mutate(tSNE1 = tsne_out_pfos$Y[,1],
         tSNE2 = tsne_out_pfos$Y[,2])


tsnepfos <- ggplot(tsne_df_pfos, aes(x = tSNE1, y = tSNE2, label = dsstox_sid, color = similarity)) +
  geom_point(alpha = 0.8, size = 4) +
  scale_color_viridis(option = "plasma", direction = -1) +
  theme_minimal() +
  theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "right",
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank())
print(tsnepfos)
ggsave(filename = "../plots/pfos_tsne.png", plot = tsnepfos, width = 7, height = 5, dpi = 300,bg = "white")
```


##Plotting 23 main PFAS
```{r}
RA_pfoa <-read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Input/genra_20251208_PFOA.csv")
RA_pfos <-read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Documents/PBTK-Modelling-PFAS/Input/genra_20251210_PFOS.csv")

RA_pfoa <- RA_pfoa %>%
  mutate(Chemical = "PFOA")


RA_pfos <- RA_pfos %>%
  mutate(Chemical = "PFOS")


genra_combined<- rbind(RA_pfoa, RA_pfos) %>%
  drop_na(similarity) 

pfas_class <- tibble(
  dsstox_sid = c(
  "DTXSID40892486",  # PFOA
  "DTXSID3031864",  # PFOS
  "DTXSID4059916",  # PFBA
  "DTXSID6062599",  # PFPeA
  "DTXSID3031862",  # PFHxA
  "DTXSID1037303",  # PFHpA
  "DTXSID8031863",  # PFNA
  "DTXSID3031860",  # PFDA
  "DTXSID8047553",  # PFUdA
  "DTXSID8031861",  # PFDoA
  "DTXSID90868151",  # PFTrDA
  "DTXSID3059921",  # PFTeDA
  "DTXSID60873015",  # PFBS
  "DTXSID8062600",  # PFPeS
  "DTXSID7040150",  # PFHxS
  "DTXSID8059920",  # PFHpS
  "DTXSID8071356",  # PFNS
  "DTXSID00873014",  # PFDS
  "DTXSID30891564",  # 4:2 FTS
  "DTXSID6067331",  # 6:2 FTS
  "DTXSID00192353",  # 8:2 FTS
  "DTXSID10624392",  # N-MeFOSAA
  "DTXSID60892504",  # N-EtFOSAA
  "DTXSID3038939",   # FOSA
  "DTXSID2060032", #DONA
  "DTXSID70880215" #Genx
  ),
PFAS_list = c(
"PFOA",
"PFOS",
"PFBA",
"PFPeA",
"PFHxA",
"PFHpA",
"PFNA",
"PFDA",
"PFUdA",
"PFDoA",
"PFTrDA",
"PFTeDA",
"PFBS",
"PFPeS",
"PFHxS",
"PFHpS",
"PFNS",
"PFDS",
"f4_2FTS",
"f6_2FTS",
"f8_2FTS",
"N_MeFOSAA",
"N_EtFOSAA",
"FOSA",
"DONA",
"HFPO-DA")
)
# Subset your main data
genra_subset <- genra_combined %>%
  left_join(pfas_class, by = "dsstox_sid") %>%
  filter(!is.na(PFAS_list))  


assign_group <- function(x) {
  # PFCAs 
  if(x %in% c("PFBA","PFPeA","PFHxA","PFHpA","PFOA","PFNA","PFDA", "PFUdA","PFDoA","PFTrDA","PFTeDA")) return("PFCAs")

  # PFSAs 
  else if(x %in% c("PFBS","PFPeS","PFHxS","PFHpS","PFOS", "PFNS","PFDS")) return("PFSAs")

  # N_2_FTS
  else if(x %in% c("f6_2FTS","f4_2FTS", "f8_2FTS")) return("FTS")
  
  # FOSAs
  else if(x %in% c("N_MeFOSAA","N_EtFOSAA","FOSA")) return("FOSAs")
  
  # Genx
  else if(x %in% c("DONA","HFPO-DA")) return("Genx")
  else return(NA)
}
genra_subset$group <- sapply(genra_subset$PFAS_list, assign_group)

compound_order <- c("PFCAs", "PFSAs", "FOSAs","FTS", "Genx")
genra_subset$group <- factor(genra_subset$group, levels = compound_order)
custom_colors_named <- c(
  "PFOS"   = "#f2844b",
  "PFOA"   = "#6a00a8")
subset<-  ggplot() +
  geom_point(data = genra_subset,
             aes(x = fct_reorder(PFAS_list, similarity, .desc = TRUE), y = similarity, color = Chemical), size = 4, alpha = 0.5, width = 0.1, stroke = 1) +
  facet_grid(~ group, scales = "free_x", space = "free_x")+
  labs(
    title = NULL,
    x = NULL,
    y = "Similarity"
  ) +
    geom_hline(yintercept = 0.4, linetype = "dashed", color = "#f2844b", linewidth =0.8) +
  geom_hline(yintercept = 0.333, linetype = "dashed", color = "#6a00a8", linewidth =0.8) +
  ylim(0, 1) +
   scale_color_manual(
    name = "Chemical",
    values = custom_colors_named
  ) +
  scale_fill_manual(
    name = "Chemical",
    values = custom_colors_named
  ) +
  scale_shape_manual(
    name = "Sex",
    values = shape_map
  ) +

   theme_minimal() +
  theme(
      text = element_text(family = "Arial", size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "right",
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_blank())
print(subset)
ggsave(filename = "../plots/23pfas.png", plot = subset, width = 9, height = 3, dpi = 300,bg = "white")


```


